<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quiz</title>
  <link rel="stylesheet" href="./../css/quiz.css" />
  <link rel="icon" href="./../img/ea logo.png" />
  <script src="./../js/sessao.js"></script>
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link
      href="https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
      rel="stylesheet">
</head>

<body onload="onloadEsconder(), validarSessao()">

  <div class="header">
    <div class="container">
      <img src="./../img/ea logo.png" alt="">
      <ul class="navbar">
        <li>
          <a href="./../index.html">Inicial</a>
        </li>
        <li>
      
          <a href="./dashboard.html">Dashboard</a>
        
        </li>
        <li>|</li>
        <li>
          <a href="./../login.html">Login</a>
        </li>
        <a href="./../cadastro.html">Cadastro</a>
      </ul>
    </div>
  </div>

  <div id="containerimg">
    <div id="img1"></div>
    <div id="pontuacaoEJogo">
      <h3>Boa sorte, <span id="b_usuario">usuário</span>!</h3>
      <button id="btnIniciarQuiz" onclick="iniciarQuiz()">INICIAR QUIZ</button>
      <button id="btndash" onclick="dashboard()">VOLTAR</button>
    </div>
    <div id="img2"></div>
  </div>
  
    <div id="pontuacaoEJogo">
    <div id="pontuacao" class="flex-colunar width-fit-content border-primary">
      <div id="pontuacaoDuranteJogo" class="flex-colunar padding-8">
        <span class="width-fit-content">Quantidade de acertos: <span id="spanCertas"></span></span>
        <span class="width-fit-content">Quantidade de erros: <span id="spanErradas"></span></span>
      </div>
      <div id="pontuacaoFinalJogo" class="flex-colunar padding-8">
       
        <span id="msgFinal" class="width-fit-content">***</span>
      </div>
    </div>

    <div id="jogo" class="width-fit-content flex-colunar border-secondary">


      <div id="infoQuestao" class="padding-8">
        <span>Questão atual: <span id="spanNumeroDaQuestaoAtual"></span> de <span id="qtdQuestoes"></span>
          questões.</span>
      </div>

      <div id="dificuldadeQuestao" class="padding-8">
        <span id="spanDificuldade"></span>
        <span id="spanGenero"></span>
      </div>

      <div id="perguntaDaQuestaoAtual" class="padding-8">
        <img id="imagemPergunta" alt="Imagem da pergunta" class="imagem-pergunta" />
        <span id="spanQuestaoExibida" class="text-bold"></span>
      </div>



      <div id="opcoes" class="padding-8">
        <div class="opcao">
          <img id="imgAlternativaA" src="" alt="Imagem Alternativa A" class="imagem-alternativa">
          <input type="radio" id="primeiraOpcao" name="option" class="radio" value="alternativaA">
          <label for="primeiraOpcao" id="labelOpcaoUm"></label>
        </div>
        <div class="opcao">
          <img id="imgAlternativaB" src="" alt="Imagem Alternativa B" class="imagem-alternativa">
          <input type="radio" id="segundaOpcao" name="option" class="radio" value="alternativaB">
          <label for="segundaOpcao" id="labelOpcaoDois"></label>
        </div>
        <div class="opcao">
          <img id="imgAlternativaC" src="" alt="Imagem Alternativa C" class="imagem-alternativa">
          <input type="radio" id="terceiraOpcao" name="option" class="radio" value="alternativaC">
          <label for="terceiraOpcao" id="labelOpcaoTres"></label>
        </div>
        <div class="opcao">
          <img id="imgAlternativaD" src="" alt="Imagem Alternativa D" class="imagem-alternativa">
          <input type="radio" id="quartaOpcao" name="option" class="radio" value="alternativaD">
          <label for="quartaOpcao" id="labelOpcaoQuatro"></label>
        </div>

      </div>



      <button onclick="submeter()" id="btnSubmeter">Submeter resposta</button>
      <br>

      <button onclick="avancar()" id="btnProx" disabled>Avançar para próxima questão</button>

      <br>

      <button onclick="tentarNovamente()" id="btnTentarNovamente" disabled>Voltar</button>


    </div>
  </div>
</div>

  <div class="footer">
    <div class="container">
      <img src="./../img/ea logo.png" alt="">
      <h4>Fabrício Todos os direitos reservados</h4>
    </div>
  </div>


</body>

</html>
<script>

  function dashboard(){
    window.location.replace("./dashboard.html"); 
  }
  const listaDeQuestoes = [
    {
      pergunta: "Qual a nacionalidade da Aitana Bonmatí?",
      alternativaA: "França",
      alternativaB: "Alemanha",
      alternativaC: "Belgica",
      alternativaD: "Espanha",
      alternativaCorreta: "alternativaD",
      dificuldade: "facil",
      genero: "feminino",
      imagemPergunta: "./../img/aitana_per.webp",
      imagensAlternativas: [
        "./../img/franca.png",
        "./../img/alemanha.png",
        "./../img/belgica.png",
        "./../img/espanha.png"
      ]
    },
    {
      pergunta: "Qual a nacionalidade do Rodri?",
      alternativaA: "Inglaterra",
      alternativaB: "Espanha",
      alternativaC: "Alemanha",
      alternativaD: "Suecia",
      alternativaCorreta: "alternativaB",
      dificuldade: "facil",
      genero: "masculino",
      imagemPergunta: "./../img/rodri.webp",
      imagensAlternativas: [
        "./../img/inglaterra.png",
        "./../img/espanha.png",
        "./../img/alemanha.png",
        "./../img/suecia.png"
      ]
    },
    {
      pergunta: "Qual a nacionalidade da Sam Keer?",
      alternativaA: "Australia",
      alternativaB: "Alemanha",
      alternativaC: "Noruega",
      alternativaD: "inglaterra",
      alternativaCorreta: "alternativaA",
      dificuldade: "media",
      genero: "feminino",
      imagemPergunta: "./../img/kerr.webp",
      imagensAlternativas: [
        "./../img/australia.png",
        "./../img/alemanha.png",
        "./../img/noruega.png",
        "./../img/inglaterra.png"
      ]
    },
    {
      pergunta: "Qual a nacionalidade do Jorginho?",
      alternativaA: "Argentina",
      alternativaB: "Brasil",
      alternativaC: "Portugal",
      alternativaD: "Italia",
      alternativaCorreta: "alternativaD",
      dificuldade: "media",
      genero: "masculino",
      imagemPergunta: "./../img/jorginho.webp",
      imagensAlternativas: [
        "./../img/argentina.png",
        "./../img/brasil.png",
        "./../img/portugal.png",
        "./../img/italia.png"
      ]
    },
    {
      pergunta: "Qual a nacionalidade da Caroline Graham Hansen?",
      alternativaA: "Suiça",
      alternativaB: "Suécia",
      alternativaC: "Noruega",
      alternativaD: "Espanha",
      alternativaCorreta: "alternativaC",
      dificuldade: "dificil",
      genero: "feminino",
      imagemPergunta: "./../img/HANSEN.webp",
      imagensAlternativas: [
        "./../img/suica.png",
        "./../img/suecia.png",
        "./../img/noruega.png",
        "./../img/espanha.png"
      ]
    },
    {
      pergunta: "Qual a nacionalidade do Alexis Mac Allister?",
      alternativaA: "Inglaterra",
      alternativaB: "Argentina",
      alternativaC: "Alemanha",
      alternativaD: "Belgica",
      alternativaCorreta: "alternativaB",
      dificuldade: "dificil",
      genero: "masculino",
      imagemPergunta: "./../img/mac.webp",
      imagensAlternativas: [
        "./../img/inglaterra.png",
        "./../img/Argentina.png",
        "./../img/alemanha.png",
        "./../img/belgica.png"
      ]
    }

  ];


  let numeroDaQuestaoAtual = 0
  let pontuacaoFinal = 0
  let tentativaIncorreta = 0
  let certas = 0
  let erradas = 0
  let quantidadeDeQuestoes = listaDeQuestoes.length

  function onloadEsconder() {
    document.getElementById('pontuacao').style.display = "none"
    document.getElementById('jogo').style.display = "none"
  }

  function iniciarQuiz() {
    
    obterUltimaTentativaDoBackend();
    document.getElementById('pontuacao').style.display = "flex"
    document.getElementById('jogo').style.display = "flex"
    document.getElementById('btnIniciarQuiz').style.display = "none"
    document.getElementById('btndash').style.display = "none"
    document.getElementById('btnTentarNovamente').style.display = "none"
    document.getElementById('img1').style.display = "none"
    document.getElementById('img2').style.display = "none"
    document.getElementById('qtdQuestoes').innerHTML = quantidadeDeQuestoes

    preencherHTMLcomQuestaoAtual(0)

    btnSubmeter.disabled = false
    btnProx.disabled = true
    btnTentarNovamente.disabled = true


  }

  function preencherHTMLcomQuestaoAtual(index) {
    
    habilitarAlternativas(true);
    const questaoAtual = listaDeQuestoes[index];
    numeroDaQuestaoAtual = index;

   
    document.getElementById("spanNumeroDaQuestaoAtual").innerHTML = Number(index) + 1;
    document.getElementById("spanQuestaoExibida").innerHTML = questaoAtual.pergunta;
    document.getElementById("labelOpcaoUm").innerHTML = questaoAtual.alternativaA;
    document.getElementById("labelOpcaoDois").innerHTML = questaoAtual.alternativaB;
    document.getElementById("labelOpcaoTres").innerHTML = questaoAtual.alternativaC;
    document.getElementById("labelOpcaoQuatro").innerHTML = questaoAtual.alternativaD;

    
    document.querySelector(".imagem-pergunta").src = questaoAtual.imagemPergunta;
    document.getElementById("imgAlternativaA").src = questaoAtual.imagensAlternativas[0];
    document.getElementById("imgAlternativaB").src = questaoAtual.imagensAlternativas[1];
    document.getElementById("imgAlternativaC").src = questaoAtual.imagensAlternativas[2];
    document.getElementById("imgAlternativaD").src = questaoAtual.imagensAlternativas[3];


    const dificuldadeElemento = document.getElementById("spanDificuldade");
    if (questaoAtual.dificuldade === "facil") {
      dificuldadeElemento.innerHTML = "Dificuldade: Fácil";
      dificuldadeElemento.style.color = "green";
    } else if (questaoAtual.dificuldade === "media") {
      dificuldadeElemento.innerHTML = "Dificuldade: Média";
      dificuldadeElemento.style.color = "orange";
    } else if (questaoAtual.dificuldade === "dificil") {
      dificuldadeElemento.innerHTML = "Dificuldade: Difícil";
      dificuldadeElemento.style.color = "red";
    }

    const generoElemento = document.getElementById("spanGenero");
    if (questaoAtual.genero === "masculino") {
      generoElemento.innerHTML = " | Gênero: Masculino";
      generoElemento.style.color = "blue";
    } else if (questaoAtual.genero === "feminino") {
      generoElemento.innerHTML = " | Gênero: Feminino";
      generoElemento.style.color = "purple";
    }
  }


  function submeter() {
    
    const options = document.getElementsByName("option"); // recupera alternativas no html

    let hasChecked = false
    for (let i = 0; i < options.length; i++) {
      if (options[i].checked) {
        hasChecked = true
        break
      }
    }

    if (!hasChecked) {
      alert("Não há alternativas escolhidas. Escolha uma opção.")
    } else {
      btnSubmeter.disabled = true
      btnProx.disabled = false

      habilitarAlternativas(false)

      checarResposta()
    }
    registrarTentativaQuiz();
  }

  function habilitarAlternativas(trueOrFalse) {
    let opcaoEscolhida = trueOrFalse ? false : true

    primeiraOpcao.disabled = opcaoEscolhida
    segundaOpcao.disabled = opcaoEscolhida
    terceiraOpcao.disabled = opcaoEscolhida
    quartaOpcao.disabled = opcaoEscolhida
  }

  function avancar() {
    btnProx.disabled = true
    btnSubmeter.disabled = false

    desmarcarRadioButtons()

    if (numeroDaQuestaoAtual < quantidadeDeQuestoes - 1) {
      preencherHTMLcomQuestaoAtual(numeroDaQuestaoAtual)
    } else if (numeroDaQuestaoAtual == quantidadeDeQuestoes - 1) {
      alert("Atenção... a próxima é a ultima questão!")
      preencherHTMLcomQuestaoAtual(numeroDaQuestaoAtual)
    } else {

      finalizarJogo()
    }
    limparCoresBackgroundOpcoes()
  }

  function tentarNovamente() {
    
    window.location.reload()
  }

  function checarResposta() {
    const questaoAtual = listaDeQuestoes[numeroDaQuestaoAtual] 
    const respostaQuestaoAtual = questaoAtual.alternativaCorreta 

    const options = document.getElementsByName("option"); 

    let alternativaCorreta = null 

    options.forEach((option) => {
      if (option.value === respostaQuestaoAtual) {
        console.log("alternativaCorreta está no componente: " + alternativaCorreta)
        alternativaCorreta = option.labels[0].id
      }
    })

    
    options.forEach((option) => {
      let pontos = 0;
      if (questaoAtual.dificuldade === "facil") {
        pontos = 1;
      } else if (questaoAtual.dificuldade === "media") {
        pontos = 3;
      } else if (questaoAtual.dificuldade === "dificil") {
        pontos = 5;
      }

      if (option.checked === true && option.value === respostaQuestaoAtual) {
        document.getElementById(alternativaCorreta).classList.add("text-success-with-bg")
        pontuacaoFinal += pontos
        certas++
        document.getElementById("spanCertas").innerHTML = certas
        numeroDaQuestaoAtual++
      } else if (option.checked && option.value !== respostaQuestaoAtual) {
        const wrongLabelId = option.labels[0].id

        document.getElementById(wrongLabelId).classList.add("text-danger-with-bg")
        document.getElementById(alternativaCorreta).classList.add("text-success-with-bg")
        tentativaIncorreta++
        erradas++
        document.getElementById("spanErradas").innerHTML = erradas
        numeroDaQuestaoAtual++
      }
    })
  }

  function limparCoresBackgroundOpcoes() {
    const options = document.getElementsByName("option");
    options.forEach((option) => {
      document.getElementById(option.labels[0].id).classList.remove("text-danger-with-bg")
      document.getElementById(option.labels[0].id).classList.remove("text-success-with-bg")
    })
  }

  function desmarcarRadioButtons() {
    const options = document.getElementsByName("option");
    for (let i = 0; i < options.length; i++) {
      options[i].checked = false;
    }
  }


    function finalizarJogo() {
    document.getElementById('btnTentarNovamente').style.display = "flex";
    let textoParaMensagemFinal = null;

    // Calculando pontos possíveis
    let pontos_possiveis = 0;
    listaDeQuestoes.forEach((questao) => {
        if (questao.dificuldade === "facil") {
            pontos_possiveis += 1;
        } else if (questao.dificuldade === "media") {
            pontos_possiveis += 3;
        } else if (questao.dificuldade === "dificil") {
            pontos_possiveis += 5;
        }
    });

    
    textoParaMensagemFinal = `Você fez ${pontuacaoFinal} pontos de ${pontos_possiveis} possíveis.`;

    document.getElementById('msgFinal').innerHTML = textoParaMensagemFinal;

    btnProx.disabled = true;
    btnSubmeter.disabled = true;
    btnTentarNovamente.disabled = false;
}

  

  function obterUltimaTentativaDoBackend() {
    const fkUsuarioVar = parseInt(sessionStorage.getItem("ID_USUARIO"));
    if (isNaN(fkUsuarioVar)) {
        alert("Erro: usuário não identificado.");
        return;
    }

    fetch(`/quiz/obterUltimaTentativa/${fkUsuarioVar}`)
    .then((resposta) => resposta.json())
    .then((data) => {
        const tentativaAtual = data.ultimaTentativa || 1;
        sessionStorage.setItem("tentativaAtual", tentativaAtual);
        console.log(`Tentativa atual setada como: ${tentativaAtual}`);
    })
    .catch((erro) => console.error("Erro ao obter última tentativa:", erro));
}

function registrarTentativaQuiz() {
  
    const questaoAtual = listaDeQuestoes[numeroDaQuestaoAtual - 1];
    const tituloVar = document.getElementById("spanQuestaoExibida").innerHTML;
    const generoVar = questaoAtual.genero;

    
    const options = document.getElementsByName("option");
    let respostaVar = null;

    options.forEach((option) => {
        if (option.checked) {
            respostaVar = option.value;
        }
    });

  

    
    let pontosVar = 0;
    if (respostaVar.toLowerCase() === questaoAtual.alternativaCorreta.toLowerCase()) {
        if (questaoAtual.dificuldade === "facil") {
            pontosVar = 1;
        } else if (questaoAtual.dificuldade === "media") {
            pontosVar = 3;
        } else if (questaoAtual.dificuldade === "dificil") {
            pontosVar = 5;
        }
    }

    
   
    const fkUsuarioVar = parseInt(sessionStorage.getItem("ID_USUARIO"));
    if (isNaN(fkUsuarioVar)) {
        alert("Erro: usuário não identificado.");
        return false;
    } 

    // Envio dos dados via fetch
    fetch("/quiz/registrarTentativa", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
        },
        body: JSON.stringify({
            tituloServer: tituloVar,
            respostaServer:  `"${respostaVar}"`,
            pontosServer: pontosVar,
            generoServer: generoVar,
            fkUsuarioServer: fkUsuarioVar,
            TentativaServer: sessionStorage.getItem("tentativaAtual"),
        }),
    })
    .then((resposta) => {
        if (resposta.ok) {
            console.log("Questão registrada com sucesso!");

          
            if (numeroDaQuestaoAtual >= listaDeQuestoes.length) {
                let tentativaAtual = parseInt(sessionStorage.getItem("tentativaAtual")) || 1;
                tentativaAtual++;
                sessionStorage.setItem("tentativaAtual", tentativaAtual);
                alert("Quiz concluído! Veja no topo da tela a quantidade de pontos feitos");
                finalizarJogo();
            }
        } else {
            resposta.text().then((msg) => alert("Erro: " + msg));
        }
    })
    .catch((erro) => {
        console.error("Erro ao registrar questão: ", erro);
        alert("Erro ao registrar questão. Tente novamente mais tarde.");
    });

    return false;
}


</script>